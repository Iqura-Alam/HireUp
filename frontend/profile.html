<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HireUp - Profile View</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .profile-header {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            padding: 2rem;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .profile-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: var(--primary-gradient);
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            background: var(--primary-gradient);
            border-radius: 50%;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: bold;
            color: white;
            border: 4px solid rgba(255, 255, 255, 0.1);
        }

        .section-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .section-title {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 1.2rem;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 0.5rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .info-item label {
            display: block;
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .info-item span {
            font-size: 1.1rem;
        }

        .timeline-item {
            padding-left: 1rem;
            border-left: 2px solid var(--primary-color);
            margin-bottom: 1.5rem;
            position: relative;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 0;
            width: 10px;
            height: 10px;
            background: var(--primary-color);
            border-radius: 50%;
        }

        .tag {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav
        style="padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; background: rgba(255, 255, 255, 0.45); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);">
        <div>
            <h2
                style="margin: 0; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 1.8rem;">
                HireUp</h2>
        </div>
        <div>
            <button onclick="if(window.history.length > 1) { window.history.back(); } else { window.close(); }"
                class="btn"
                style="background: transparent; border: 1px solid var(--text-muted); width: auto; padding: 0.5rem 1rem;">Back</button>
        </div>
    </nav>

    <div class="container" id="profile-container">
        <p style="text-align: center; color: var(--text-muted);">Loading profile...</p>
    </div>

    <script src="js/auth.js"></script>
    <script>
        const API_CANDIDATE = 'http://localhost:5000/api/candidate';
        const API_EMPLOYER = 'http://localhost:5000/api/employer';
        const API_TRAINER = 'http://localhost:5000/api/trainer';

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const type = urlParams.get('type'); // 'candidate', 'employer', or 'trainer'
            const id = urlParams.get('id');

            if (!type || !id) {
                document.getElementById('profile-container').innerHTML = '<p style="text-align: center; color: red;">Invalid profile link.</p>';
                return;
            }

            loadProfile(type, id);
        });

        async function loadProfile(type, id) {
            try {
                let url = '';

                if (type === 'candidate') {
                    url = `${API_CANDIDATE}/public/${id}`;
                } else if (type === 'trainer') {
                    url = `${API_TRAINER}/public/${id}`;
                } else {
                    url = `${API_EMPLOYER}/public/${id}`;
                }

                const res = await fetch(url, {
                    headers: { 'x-auth-token': localStorage.getItem('token') }
                });

                if (!res.ok) {
                    throw new Error('Failed to fetch profile');
                }

                const data = await res.json();
                renderProfile(type, data);

            } catch (err) {
                console.error(err);
                document.getElementById('profile-container').innerHTML = `
                    <div style="text-align: center; margin-top: 2rem;">
                        <p style="color: red; font-size: 1.1rem; margin-bottom: 1rem;">Error loading profile. Please ensure you are logged in.</p>
                        <a href="login.html" class="btn" style="width: auto; padding: 0.5rem 2rem;">Go to Login</a>
                    </div>
                `;
            }
        }

        function renderProfile(type, data) {
            const container = document.getElementById('profile-container');

            if (type === 'candidate') {
                const p = data.profile;
                const sections = data.sections;

                // Skills
                let skillsHtml = '<p style="color:var(--text-muted)">No skills listed.</p>';
                if (p.skills && p.skills.length > 0) {
                    skillsHtml = p.skills.map(s => `<span class="tag">${s}</span>`).join('');
                }

                // Experience
                let expHtml = '<p style="color:var(--text-muted)">No experience listed.</p>';
                if (sections.experience && sections.experience.length > 0) {
                    expHtml = sections.experience.map(e => `
                        <div class="timeline-item">
                            <h4 style="margin:0">${e.title}</h4>
                            <span style="color:var(--primary-color)">${e.company_name}</span>
                            <span style="display:block; font-size:0.85rem; color:var(--text-muted); margin: 0.25rem 0;">
                                ${new Date(e.start_date).toLocaleDateString()} - 
                                ${e.end_date ? new Date(e.end_date).toLocaleDateString() : 'Present'}
                            </span>
                            <p style="font-size:0.9rem; color:#e2e8f0;">${e.description || ''}</p>
                        </div>
                    `).join('');
                }

                // Education
                let eduHtml = '<p style="color:var(--text-muted)">No education listed.</p>';
                if (sections.education && sections.education.length > 0) {
                    eduHtml = sections.education.map(e => `
                        <div class="timeline-item">
                            <h4 style="margin:0">${e.institution}</h4>
                            <span style="color:var(--text-muted)">${e.degree} in ${e.field_of_study}</span>
                            <span style="display:block; font-size:0.85rem; color:var(--text-muted); margin: 0.25rem 0;">
                                ${e.start_date ? new Date(e.start_date).getFullYear() : ''} - 
                                ${e.end_date ? new Date(e.end_date).getFullYear() : 'Present'}
                            </span>
                        </div>
                    `).join('');
                }

                // Projects
                let projHtml = '<p style="color:var(--text-muted)">No projects listed.</p>';
                if (sections.projects && sections.projects.length > 0) {
                    projHtml = sections.projects.map(pr => `
                        <div class="timeline-item">
                        <h4 style="margin:0">${pr.title}</h4>
                            ${pr.project_url ? `<a href="${pr.project_url}" target="_blank" style="color:var(--primary-color); font-size:0.9rem;">${pr.project_url}</a>` : ''}
                    <span style="display:block; font-size:0.85rem; color:var(--text-muted); margin: 0.25rem 0;">
                    ${pr.start_date ? new Date(pr.start_date).getFullYear() : ''} -
                    ${pr.end_date ? new Date(pr.end_date).getFullYear() : 'Present'}
                            </span>
                        <p style="font-size:0.9rem; color:#e2e8f0;">${pr.description || ''}</p>
                        </div>
                        `).join('');
                }

                container.innerHTML = `
                        <div class="profile-header">
                        <div class="profile-avatar">${p.first_name ? p.first_name.charAt(0) : 'C'}</div>
                        <h1 style="margin:0">${p.full_name}</h1>
                        <p style="color: var(--primary-color); font-size: 1.1rem;">${p.headline || 'Candidate'}</p>
                        <p style="color: var(--text-muted); margin-top: 0.5rem;">${p.city || ''}${p.city && p.country ? ', ' : ''}${p.country || ''}</p>
                        <p style="margin-top: 0.5rem; color: #a855f7;"><strong style="color: var(--text-muted);">Experience:</strong> ${p.experience_years ? p.experience_years + ' Years' : 'Not specified'}</p>

                        <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: center; align-items: center; flex-wrap: wrap;">
                            ${p.email ? `<span style="font-size:0.95rem; color:var(--text-muted);">‚úâÔ∏è ${p.email}</span>` : ''}
                            ${p.contact_number ? `<a href="tel:${p.contact_number}" class="btn" style="width:auto; padding:0.5rem 1rem; font-size:0.9rem; background: var(--glass-bg); border: 1px solid var(--text-muted);">Call</a>` : ''}
                            ${p.linkedin_url ? `<a href="${p.linkedin_url}" target="_blank" class="btn" style="width:auto; padding:0.5rem 1rem; font-size:0.9rem; background: #0077b5;">LinkedIn</a>` : ''}
                            ${p.github_url ? `<a href="${p.github_url}" target="_blank" class="btn" style="width:auto; padding:0.5rem 1rem; font-size:0.9rem; background: #333;">GitHub</a>` : ''}
                        </div>
                    </div>

                    <div class="info-grid">
                        <div class="section-card">
                            <h3 class="section-title">About</h3>
                            <p style="line-height: 1.6;">${p.summary || 'No summary provided.'}</p>
                        </div>

                        <div class="section-card">
                            <h3 class="section-title">Job Preferences</h3>
                            <p style="margin-bottom: 0.5rem;"><strong style="color: var(--text-muted);">Role:</strong> ${p.desired_job_title || 'Any'}</p>
                            <p style="margin-bottom: 0.5rem;"><strong style="color: var(--text-muted);">Type:</strong> ${p.employment_type || 'Any'}</p>
                            <p style="margin-bottom: 0.5rem;"><strong style="color: var(--text-muted);">Work Mode:</strong> ${p.work_mode_preference || 'Any'}</p>
                            <p style="margin-bottom: 0.5rem;"><strong style="color: var(--text-muted);">Salary Expected:</strong> ${p.expected_salary_min ? p.currency + ' ' + p.expected_salary_min + ' - ' + (p.expected_salary_max || 'Any') : 'Not specified'}</p>
                            <p style="margin-bottom: 0.5rem;"><strong style="color: var(--text-muted);">Notice Period:</strong> ${p.notice_period_days !== null ? p.notice_period_days + ' Days' : 'Not specified'}</p>
                            <p style="margin-bottom: 0.5rem;"><strong style="color: var(--text-muted);">Relocate:</strong> ${p.willing_to_relocate === true ? 'Yes' : (p.willing_to_relocate === false ? 'No' : 'Not specified')}</p>
                        </div>
                    </div>

                    <div class="section-card">
                        <h3 class="section-title">Skills</h3>
                        <div>${skillsHtml}</div>
                    </div>

                    <div class="info-grid">
                        <div class="section-card" style="margin-bottom: 0;">
                            <h3 class="section-title">Experience</h3>
                            <div>${expHtml}</div>
                        </div>

                        <div class="section-card" style="margin-bottom: 0;">
                            <h3 class="section-title">Education</h3>
                            <div>${eduHtml}</div>
                        </div>
                    </div>
                    
                    <div class="section-card" style="margin-top: 1.5rem;">
                        <h3 class="section-title">Projects</h3>
                        <div>${projHtml}</div>
                    </div>
                `;

            } else if (type === 'trainer') {
                // TRAINER
                const t = data;
                let coursesHtml = '<p style="color:var(--text-muted)">No courses published yet.</p>';
                if (t.courses && t.courses.length > 0) {
                    coursesHtml = t.courses.map(c => `
                        <div style="padding: 1rem; border: 1px solid var(--glass-border); border-radius: 10px; margin-bottom: 0.75rem;">
                            <div style="display:flex; justify-content:space-between; align-items:start;">
                                <div>
                                    <h4 style="margin:0; color: #a855f7;">${c.title}</h4>
                                    <p style="font-size:0.85rem; color:var(--text-muted); margin:0.25rem 0;">${c.description || ''}</p>
                                </div>
                                <div style="text-align:right; white-space:nowrap;">
                                    <span style="font-weight:bold; color:#10b981;">${c.fee} BDT</span><br>
                                    <small style="color:var(--text-muted);">${c.duration_days} Days ‚Ä¢ ${c.mode}</small>
                                </div>
                            </div>
                            <div style="margin-top:0.5rem; font-size:0.85rem; color:var(--text-muted);">Students: <strong style="color: var(--text-main);">${c.enrolled_count}</strong></div>
                        </div>
                        `).join('');
                }

                container.innerHTML = `
                        <div class="profile-header">
                        <div class="profile-avatar">${(t.organization_name || t.username || 'T').charAt(0)}</div>
                        <h1 style="margin:0">${t.organization_name || t.username}</h1>
                        <p style="color: var(--primary-color); font-size: 1.1rem;">${t.specialization || 'Trainer'}</p>
                        
                        <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: center;">
                            ${t.email ? `<a href="mailto:${t.email}" class="btn" style="width:auto; padding:0.5rem 1rem; font-size:0.9rem;">Email</a>` : ''}
                            ${t.contact_number ? `<a href="tel:${t.contact_number}" class="btn" style="width:auto; padding:0.5rem 1rem; font-size:0.9rem; background: var(--glass-bg); border: 1px solid var(--text-muted);">Call</a>` : ''}
                        </div>
                    </div>

                    <div class="section-card">
                        <h3 class="section-title">Overview</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <label>Specialization</label>
                                <span>${t.specialization || '‚Äî'}</span>
                            </div>
                            <div class="info-item">
                                <label>Organization</label>
                                <span>${t.organization_name || '‚Äî'}</span>
                            </div>
                            <div class="info-item">
                                <label>Total Courses</label>
                                <span style="color: var(--primary-color); font-weight: bold;">${t.courses ? t.courses.length : 0}</span>
                            </div>
                        </div>
                    </div>

                    <div class="section-card">
                        <h3 class="section-title">Published Courses</h3>
                        ${coursesHtml}
                    </div>
                `;

            } else {
                // EMPLOYER
                const e = data;

                container.innerHTML = `
                        <div class="profile-header">
                        <div class="profile-avatar" style="border-radius: 12px;">${e.company_name.charAt(0)}</div>
                        <h1 style="margin:0">${e.company_name}</h1>
                        <p style="color: var(--primary-color); font-size: 1.1rem;">${e.industry || 'Company'}</p>
                        <p style="color: var(--text-muted); margin-top: 0.5rem;">${e.location || ''}</p>
                        
                        <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: center; align-items: center; flex-wrap: wrap;">
                            ${e.website ? `<a href="${e.website.startsWith('http') ? e.website : 'https://' + e.website}" target="_blank" class="btn" style="width:auto; padding:0.5rem 1rem; font-size:0.9rem;">Visit Website</a>` : ''}
                            ${e.contact_number ? `<span style="font-size:0.95rem; color:var(--text-muted);">üìû ${e.contact_number}</span>` : ''}
                        </div>
                    </div>

                        <div class="info-grid">
                            <div class="section-card">
                                <h3 class="section-title">Overview</h3>
                                <div class="info-item">
                                    <label>Industry</label>
                                    <span>${e.industry || 'Not specified'}</span>
                                </div>
                                <div style="margin-top: 1rem;" class="info-item">
                                    <label>Location</label>
                                    <span>${e.location || 'Not specified'}</span>
                                </div>
                                <div style="margin-top: 1rem;" class="info-item">
                                    <label>Open Jobs</label>
                                    <span style="color: var(--primary-color); font-weight: bold;">${e.open_jobs} Active Postings</span>
                                </div>
                            </div>
                        </div>
                `;

                // Auto-fetch jobs if there are any
                if (e.open_jobs > 0) {
                    container.innerHTML += `
                        <div class="section-card" id="employer-jobs-section">
                        <h3 class="section-title">Job Openings</h3>
                        <div id="employer-jobs-list">
                            <p style="color: var(--text-muted); text-align: center;">Loading jobs...</p>
                        </div>
                    </div>
                        `;

                    setTimeout(async () => {
                        try {
                            // We can use the public job search endpoint, filtered by this company name
                            const res = await fetch(`${API_CANDIDATE}/jobs?company=${encodeURIComponent(e.company_name)}`, {
                                headers: { 'x-auth-token': localStorage.getItem('token') }
                            });
                            if (res.ok) {
                                const jobs = await res.json();
                                const listContainer = document.getElementById('employer-jobs-list');

                                if (jobs.length === 0) {
                                    listContainer.innerHTML = '<p style="color: var(--text-muted);">No active jobs found.</p>';
                                    return;
                                }

                                listContainer.innerHTML = jobs.map(j => {
                                    let skillsHtml = '';
                                    if (j.required_skills && j.required_skills.length > 0) {
                                        const topSkills = j.required_skills.slice(0, 5).map(s => `<span class="tag" style="background: rgba(168, 85, 247, 0.1); color: var(--primary-color); border: 1px solid rgba(168, 85, 247, 0.3); font-size: 0.75rem;">${s}</span>`).join('');
                                        const moreCount = j.required_skills.length > 5 ? `<span class="tag" style="background: transparent; color: var(--text-muted); font-size: 0.75rem;">+${j.required_skills.length - 5} more</span>` : '';
                                        skillsHtml = `<div style="margin-top: 1rem;">${topSkills}${moreCount}</div>`;
                                    }

                                    return `
                                        <div style="padding: 1.5rem; background: rgba(255,255,255,0.02); border: 1px solid var(--glass-border); border-radius: 12px; margin-bottom: 1rem;">
                                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                                <div>
                                                    <h4 style="margin: 0; color: var(--primary-color); font-size: 1.1rem;">${j.title}</h4>
                                                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;">
                                                        ${j.location || 'Remote'} ‚Ä¢ ${j.employment_type || 'Full-time'}
                                                    </div>
                                                </div>
                                                <a href="jobs.html?open=${j.job_id}" class="btn" style="width: auto; padding: 0.4rem 1rem; font-size: 0.85rem;">View Job</a>
                                            </div>
                                            <div style="margin-top: 1rem; font-size: 0.9rem;">
                                                <strong style="color: var(--text-muted);">Salary:</strong> ${j.salary_range ? j.salary_range : 'Negotiable'}
                                            </div>
                                            ${skillsHtml}
                                        </div>
                                    `;
                                }).join('');
                            }
                        } catch (err) {
                            console.error('Failed to load employer jobs:', err);
                            const listContainer = document.getElementById('employer-jobs-list');
                            if (listContainer) listContainer.innerHTML = '<p style="color: red;">Error loading jobs.</p>';
                        }
                    }, 500);
                }
            }
        }
    </script>
</body>

</html>