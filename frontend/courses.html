<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HireUp - Browse Courses</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <style>
        .container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .course-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }

        .course-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-color);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .trainer-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .trainer-logo {
            width: 50px;
            height: 50px;
            background: var(--primary-gradient);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 1.2rem;
        }

        .skills-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .skill-tag {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .rating-stars {
            color: #fbbf24;
            display: flex;
            gap: 2px;
            align-items: center;
        }

        .star-input {
            display: flex;
            gap: 5px;
            cursor: pointer;
            font-size: 1.5rem;
            color: #4b5563;
        }

        .star-input span:hover,
        .star-input span.active {
            color: #fbbf24;
        }

        .modal {
            position: fixed;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: #1e1e2e;
            margin: 10% auto;
            padding: 2rem;
            border: 1px solid var(--glass-border);
            width: 90%;
            max-width: 500px;
            border-radius: 15px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        @media (max-width: 992px) {
            .container>div {
                grid-template-columns: 1fr !important;
            }

            aside {
                position: static !important;
                margin-bottom: 2rem;
            }

            #courses-feed {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav
        style="padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; background: rgba(255, 255, 255, 0.45); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);">
        <div style="display: flex; align-items: center; gap: 2rem;">
            <h2
                style="margin: 0; background: var(--primary-gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-size: 1.8rem;">
                HireUp</h2>
            <div class="nav-links">
                <a href="candidate_dashboard.html"
                    style="color: var(--text-muted); text-decoration: none; margin-right: 1.5rem;">Dashboard</a>
                <a href="jobs.html" style="color: var(--text-muted); text-decoration: none; margin-right: 1.5rem;">Find
                    Jobs</a>
                <a href="courses.html" style="color: var(--text-main); font-weight: bold; text-decoration: none;">Explore
                    Courses</a>
            </div>
        </div>
        <div style="display: flex; align-items: center; gap: 1rem;">
            <button onclick="window.location.href='jobs.html'" class="btn"
                style="background: var(--primary-color); width: auto; padding: 0.5rem 1rem; display: none;"
                id="nav-jobs-btn">Jobs</button>
            <button onclick="window.location.href='recommended-jobs.html'" class="btn"
                style="background: #10b981; width: auto; padding: 0.5rem 1rem; display: none;"
                id="nav-recommended-btn">Recommended</button>
            <button onclick="logout()" class="btn"
                style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.5); width: auto; padding: 0.5rem 1rem;">Logout</button>
        </div>
    </nav>

    </nav>

    <!-- Review Modal -->
    <div id="reviewModal" class="modal hidden">
        <div class="modal-content">
            <h2 style="margin-bottom: 1rem;">Review Course</h2>
            <p id="review-course-title" style="color: var(--text-muted); margin-bottom: 1.5rem;"></p>

            <input type="hidden" id="review-course-id">

            <div class="form-group">
                <label>Rating</label>
                <div id="star-selector" class="star-input">
                    <span data-value="1">★</span>
                    <span data-value="2">★</span>
                    <span data-value="3">★</span>
                    <span data-value="4">★</span>
                    <span data-value="5">★</span>
                </div>
                <input type="hidden" id="rating-value" value="0">
            </div>

            <div class="form-group">
                <label>Your Feedback</label>
                <textarea id="review-text" rows="4" style="width: 100%;" placeholder="What did you learn?"></textarea>
            </div>

            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button onclick="submitReview()" class="btn">Submit Review</button>
                <button onclick="closeReviewModal()" class="btn"
                    style="background: transparent; border: 1px solid var(--glass-border);">Cancel</button>
            </div>
        </div>
    </div>

    <div class="container" style="max-width: 1200px;">
        <div style="margin-bottom: 2rem;">
            <h1 style="margin-bottom: 0.5rem;">Upskill Your Career</h1>
            <p style="color: var(--text-muted);">Discover courses to bridge your skill gaps and advance your journey.
            </p>
        </div>

        <div style="display: grid; grid-template-columns: 280px 1fr; gap: 2rem; align-items: start;">
            <!-- Sidebar Filters -->
            <aside class="card" style="padding: 1.5rem; position: sticky; top: 100px;">
                <h3
                    style="font-size: 1.1rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--glass-border); padding-bottom: 0.75rem;">
                    Filters</h3>

                <div class="form-group">
                    <label
                        style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 0.5rem;">Search
                        Course</label>
                    <input type="text" id="filter-search" placeholder="Keyword..." oninput="loadCourses()"
                        style="width: 100%;">
                </div>

                <div class="form-group">
                    <label
                        style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 0.5rem;">Skills</label>
                    <select id="filter-skill" multiple placeholder="Select skills..." onchange="loadCourses()">
                        <!-- Dynamic Skills -->
                    </select>
                </div>

                <div class="form-group">
                    <label
                        style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 0.5rem;">Trainer</label>
                    <select id="filter-trainer" onchange="loadCourses()" style="width: 100%;">
                        <option value="">All Trainers</option>
                        <!-- Dynamic Trainers -->
                    </select>
                </div>

                <div class="form-group">
                    <label
                        style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 0.5rem;">Max
                        Fee (BDT)</label>
                    <input type="number" id="filter-fee" placeholder="Limit" oninput="loadCourses()"
                        style="width: 100%;">
                </div>

                <div class="form-group">
                    <label
                        style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 0.5rem;">Mode</label>
                    <select id="filter-mode" onchange="loadCourses()" style="width: 100%;">
                        <option value="All">All Modes</option>
                        <option value="Online">Online</option>
                        <option value="Offline">Offline</option>
                    </select>
                </div>
                <div class="form-group">
                    <label
                        style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 0.5rem;">Sort
                        By</label>
                    <select id="filter-sort" onchange="loadCourses()" style="width: 100%;">
                        <option value="newest">Newest First</option>
                        <option value="rating_high">Rating: High to Low</option>
                    </select>
                </div>

                <button onclick="resetFilters()"
                    style="width: 100%; background: none; border: 1px solid var(--glass-border); color: var(--text-muted); padding: 0.6rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem; margin-top: 1rem; transition: all 0.2s;">
                    Reset All Filters
                </button>
            </aside>

            <!-- Main Results Area -->
            <main>
                <div id="courses-feed"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 1.5rem;">
                    <p style="text-align: center; color: var(--text-muted); grid-column: 1/-1;">Loading courses...</p>
                </div>
            </main>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script>
        const API_CANDIDATE = 'http://localhost:5000/api/candidate';
        let filterTimeout;
        let skillSelectInstance;

        async function loadCourses() {
            clearTimeout(filterTimeout);

            // Simple debounce for smoother filtering
            filterTimeout = setTimeout(async () => {
                // Get multiple selected skills from TomSelect
                let selectedSkills = [];
                if (skillSelectInstance) {
                    selectedSkills = skillSelectInstance.getValue();
                    if (!Array.isArray(selectedSkills)) {
                        selectedSkills = selectedSkills ? [selectedSkills] : [];
                    }
                }

                const trainer = document.getElementById('filter-trainer').value;
                const maxFee = document.getElementById('filter-fee').value;
                const mode = document.getElementById('filter-mode').value;
                const search = document.getElementById('filter-search').value;
                const sortBy = document.getElementById('filter-sort').value;

                // Build Query String
                const params = new URLSearchParams();
                if (selectedSkills.length > 0) params.append('skill', selectedSkills.join(','));
                if (trainer) params.append('trainer', trainer);
                if (maxFee) params.append('maxFee', maxFee);
                if (mode && mode !== 'All') params.append('mode', mode);
                if (search) params.append('search', search);
                if (sortBy) params.append('sortBy', sortBy);

                try {
                    const res = await fetch(`${API_CANDIDATE}/courses?${params.toString()}`, {
                        headers: { 'x-auth-token': localStorage.getItem('token') }
                    });
                    const courses = await res.json();

                    const feed = document.getElementById('courses-feed');
                    feed.innerHTML = '';

                    if (courses.length === 0) {
                        feed.innerHTML = '<div style="text-align: center; padding: 3rem; background: rgba(255,255,255,0.02); border-radius: 12px; border: 1px dashed var(--glass-border);">' +
                            '<p style="color: var(--text-muted); margin: 0;">No courses found matching your criteria.</p>' +
                            '<button onclick="resetFilters()" style="margin-top: 1rem; color: var(--primary-color); background: none; border: none; cursor: pointer; text-decoration: underline;">Clear all filters</button>' +
                            '</div>';
                        return;
                    }

                    courses.forEach(course => {
                        const skillsHtml = course.skills_taught
                            ? course.skills_taught.map(s => `<span class="skill-tag">${s}</span>`).join('')
                            : '';

                        let enrollBtn = '';
                        if (course.is_enrolled) {
                            let statusLabel = '';
                            let btnColor = '';

                            if (course.enrollment_status === 'Applied') {
                                statusLabel = 'Applied';
                                btnColor = '#fbbf24'; // Amber
                                enrollBtn = `<button class="btn" disabled style="background: ${btnColor}; cursor: not-allowed; width: auto; opacity: 0.8; border: none;">${statusLabel}</button>`;
                            } else if (course.enrollment_status === 'Rejected') {
                                statusLabel = 'Re-apply';
                                btnColor = '#6366f1'; // Indigo/Cool Blue
                                enrollBtn = `<button onclick="enroll('${course.course_id}')" class="btn" style="background: ${btnColor}; width: auto; border: none;">${statusLabel}</button>`;
                            } else if (course.enrollment_status === 'Shortlisted' || course.enrollment_status === 'Hired') {
                                if (course.completion_status === 'Completed') {
                                    statusLabel = 'Completed';
                                    btnColor = '#10b981'; // Green
                                    enrollBtn = `
                                        <div style="display: flex; gap: 0.5rem;">
                                            <button class="btn" disabled style="background: ${btnColor}; cursor: not-allowed; width: auto; opacity: 0.8; border: none;">${statusLabel}</button>
                                            <button onclick="openReviewModal('${course.course_id}', '${course.title.replace(/'/g, "\\'")}')" class="btn" style="background: var(--primary-color); width: auto; padding: 0.5rem 1rem;">Review</button>
                                        </div>
                                    `;
                                } else {
                                    statusLabel = 'Enrolled';
                                    btnColor = '#10b981'; // Green
                                    enrollBtn = `<button class="btn" disabled style="background: ${btnColor}; cursor: not-allowed; width: auto; opacity: 0.8; border: none;">${statusLabel}</button>`;
                                }
                            }
                        } else {
                            enrollBtn = `<button onclick="enroll('${course.course_id}')" class="btn" style="width: auto; padding: 0.75rem 2rem;">Enroll Now</button>`;
                        }

                        // Rating display
                        const avgRating = parseFloat(course.average_rating) || 0;
                        const fullStars = Math.floor(avgRating);
                        const hasHalf = (avgRating - fullStars) >= 0.5;
                        const ratingHtml = `
                            <div class="rating-stars" title="${avgRating} average rating">
                                ${'★'.repeat(fullStars)}${hasHalf ? '½' : ''}
                                <span style="color: var(--text-muted); font-size: 0.8rem; margin-left: 4px;">(${course.total_reviews || 0})</span>
                                <button onclick="openViewReviews('${course.course_id}', '${course.title.replace(/'/g, "\\'")}')" 
                                        style="background: none; border: none; color: var(--primary-color); text-decoration: underline; font-size: 0.8rem; cursor: pointer; margin-left: 8px;">View Reviews</button>
                            </div>
                        `;

                        const div = document.createElement('div');
                        div.className = 'course-card';
                        div.innerHTML = `
                            <div class="header">
                                <div class="trainer-info">
                                    <div class="trainer-logo">${course.trainer_name ? course.trainer_name.charAt(0) : 'T'}</div>
                                    <div>
                                        <h3 style="margin: 0;">${course.title}</h3>
                                        <span style="color: var(--text-muted); font-size: 0.9rem;">${course.trainer_name || 'Individual Trainer'} • ${course.mode}</span>
                                        ${ratingHtml}
                                        <br>
                                        <a href="profile.html?type=trainer&id=${course.trainer_id}" style="font-size: 0.8rem; color: var(--primary-color); text-decoration: underline;">View Trainer Profile</a>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <span style="display: block; font-weight: bold; color: #10b981; font-size: 1.1rem;">${parseFloat(course.fee).toLocaleString()} BDT</span>
                                    <small style="color: var(--text-muted); font-weight: 500;">${course.duration_days} Days</small>
                                </div>
                            </div>
                            
                            <p style="color: #cbd5e0; line-height: 1.6; margin-bottom: 1rem; font-size: 0.95rem;">${course.description || 'No description provided.'}</p>
                            
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 1.5rem; border-top: 1px solid rgba(0, 0, 0, 0.02); padding-top: 1.25rem;">
                                <div class="skills-list" style="margin: 0;">
                                    ${skillsHtml}
                                </div>
                                ${enrollBtn}
                            </div>
                        `;

                        feed.appendChild(div);
                    });

                } catch (err) {
                    console.error('Filter Error:', err);
                    document.getElementById('courses-feed').innerHTML = '<p style="color: #fca5a5; text-align: center; padding: 2rem;">Connection Error. Could not fetch courses.</p>';
                }
            }, 300);
        }

        async function loadFilterOptions() {
            try {
                const res = await fetch(`${API_CANDIDATE}/course-filters`, {
                    headers: { 'x-auth-token': localStorage.getItem('token') }
                });

                if (!res.ok) throw new Error('Failed to load filters');

                const { skills, trainers } = await res.json();

                const skillSelect = document.getElementById('filter-skill');
                const trainerSelect = document.getElementById('filter-trainer');

                if (skills && skills.length > 0) {
                    skills.forEach(skill => {
                        const opt = document.createElement('option');
                        opt.value = skill;
                        opt.textContent = skill;
                        skillSelect.appendChild(opt);
                    });
                } else {
                    console.warn('No skills found for filter');
                }

                if (trainers && trainers.length > 0) {
                    trainers.forEach(trainer => {
                        const opt = document.createElement('option');
                        opt.value = trainer;
                        opt.textContent = trainer;
                        trainerSelect.appendChild(opt);
                    });
                }

                // Initialize TomSelect for skills (Ensure it initializes even with empty list)
                skillSelectInstance = new TomSelect('#filter-skill', {
                    plugins: ['remove_button'],
                    onItemAdd: function () { this.setTextboxValue(''); this.refreshOptions(); },
                    persist: false,
                    create: false,
                    allowEmptyOption: true,
                    placeholder: skills && skills.length > 0 ? "Search skills..." : "No skills available"
                });

            } catch (err) {
                console.error('Error loading filter options:', err);
                // Initialize anyway to avoid breaking UI
                if (!skillSelectInstance) {
                    skillSelectInstance = new TomSelect('#filter-skill', {
                        placeholder: "Error loading skills"
                    });
                }
            }
        }

        function resetFilters() {
            if (skillSelectInstance) skillSelectInstance.clear();
            document.getElementById('filter-search').value = '';
            document.getElementById('filter-trainer').value = '';
            document.getElementById('filter-fee').value = '';
            document.getElementById('filter-mode').value = 'All';
            document.getElementById('filter-sort').value = 'newest';
            loadCourses();
        }

        async function enroll(courseId) {
            try {
                const res = await fetch(`${API_CANDIDATE}/courses/${courseId}/enroll`, {
                    method: 'POST',
                    headers: { 'x-auth-token': localStorage.getItem('token') }
                });

                if (res.ok) {
                    alert('Enrollment request submitted!');
                    loadCourses();
                } else {
                    const data = await res.json();
                    if (res.status === 403 && data.remaining) {
                        // Better formatting for "2 days 23:52:34.946678"
                        let timeStr = data.remaining.split('.')[0]; // remove microseconds
                        timeStr = timeStr.replace(/00:/g, '').trim();
                        alert(`Re-application Cooldown: Please wait ${timeStr} before applying again.`);
                    } else {
                        alert(data.message || 'Enrollment failed');
                    }
                }
            } catch (err) {
                console.error(err);
                alert('Server error');
            }
        }

        // Review Modal Functions
        function openReviewModal(courseId, title) {
            document.getElementById('review-course-id').value = courseId;
            document.getElementById('review-course-title').textContent = title;
            document.getElementById('reviewModal').classList.remove('hidden');
            resetReviewForm();
        }

        function closeReviewModal() {
            document.getElementById('reviewModal').classList.add('hidden');
        }

        function resetReviewForm() {
            document.getElementById('rating-value').value = 0;
            document.getElementById('review-text').value = '';
            document.querySelectorAll('#star-selector span').forEach(s => s.classList.remove('active'));
        }

        // Star selection logic
        document.querySelectorAll('#star-selector span').forEach(star => {
            star.addEventListener('click', function () {
                const val = this.getAttribute('data-value');
                document.getElementById('rating-value').value = val;

                document.querySelectorAll('#star-selector span').forEach(s => {
                    if (s.getAttribute('data-value') <= val) {
                        s.classList.add('active');
                    } else {
                        s.classList.remove('active');
                    }
                });
            });
        });

        async function submitReview() {
            const courseId = document.getElementById('review-course-id').value;
            const rating = document.getElementById('rating-value').value;
            const reviewText = document.getElementById('review-text').value;

            if (rating == 0) {
                alert('Please select a rating');
                return;
            }

            try {
                const res = await fetch(`${API_CANDIDATE}/courses/${courseId}/review`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-auth-token': localStorage.getItem('token')
                    },
                    body: JSON.stringify({ rating, reviewText })
                });

                const data = await res.json();
                if (res.ok) {
                    alert('Thank you for your review!');
                    closeReviewModal();
                    loadCourses();
                } else {
                    alert(data.message || 'Failed to submit review');
                }
            } catch (err) {
                console.error(err);
                alert('Server error while submitting review');
            }
        }

        async function openViewReviews(courseId, title) {
            document.getElementById('view-reviews-title').textContent = `Reviews for ${title}`;
            document.getElementById('viewReviewsModal').classList.remove('hidden');
            document.getElementById('reviews-container').innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">Loading reviews...</p>';

            try {
                const res = await fetch(`${API_CANDIDATE}/courses/${courseId}/reviews`, {
                    headers: { 'x-auth-token': localStorage.getItem('token') }
                });
                const reviews = await res.json();

                const container = document.getElementById('reviews-container');
                if (reviews.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 2rem;">No reviews yet for this course.</p>';
                    return;
                }

                container.innerHTML = reviews.map(r => `
                    <div style="background: rgba(0, 0, 0, 0.02); padding: 1rem; border-radius: 8px; border: 1px solid var(--glass-border);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="font-weight: 600; color: var(--primary-color);">${r.username}</span>
                            <span style="color: #fbbf24;">${'★'.repeat(r.rating)}</span>
                        </div>
                        <p style="margin: 0; font-size: 0.95rem; line-height: 1.5;">${r.review_text || '<span style="color: var(--text-muted); font-style: italic;">No comment.</span>'}</p>
                        <div style="text-align: right; margin-top: 0.5rem;">
                            <small style="color: var(--text-muted);">${new Date(r.created_at).toLocaleDateString()}</small>
                        </div>
                    </div>
                `).join('');

            } catch (err) {
                console.error('Fetch Reviews Error:', err);
                document.getElementById('reviews-container').innerHTML = '<p style="color: #fca5a5; text-align: center; padding: 1rem;">Failed to load reviews.</p>';
            }
        }

        function closeViewReviewsModal() {
            document.getElementById('viewReviewsModal').classList.add('hidden');
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof checkAuth === 'function') checkAuth();
            loadFilterOptions(); // Load dynamic dropdowns
            loadCourses();
        });
    </script>
    <!-- View Reviews Modal -->
    <div id="viewReviewsModal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 id="view-reviews-title" style="margin: 0;">Course Reviews</h2>
                <span onclick="closeViewReviewsModal()"
                    style="cursor: pointer; font-size: 1.5rem; color: var(--text-muted);">&times;</span>
            </div>

            <div id="reviews-container"
                style="max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 1rem;">
                <p style="color: var(--text-muted); text-align: center;">Loading reviews...</p>
            </div>

            <div style="margin-top: 1.5rem; text-align: right;">
                <button onclick="closeViewReviewsModal()" class="btn"
                    style="width: auto; padding: 0.5rem 1.5rem;">Close</button>
            </div>
        </div>
    </div>
</body>

</html>