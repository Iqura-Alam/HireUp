<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HireUp - Browse Courses</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <style>
        .container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .course-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }

        .course-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-color);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .trainer-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .trainer-logo {
            width: 50px;
            height: 50px;
            background: var(--primary-gradient);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 1.2rem;
        }

        .skills-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .skill-tag {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        @media (max-width: 992px) {
            .container>div {
                grid-template-columns: 1fr !important;
            }

            aside {
                position: static !important;
                margin-bottom: 2rem;
            }

            #courses-feed {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav
        style="padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; background: rgba(30,30,46,0.9); backdrop-filter: blur(10px);">
        <div style="display: flex; align-items: center; gap: 2rem;">
            <h2
                style="margin: 0; background: var(--primary-gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-size: 1.8rem;">
                HireUp</h2>
            <div class="nav-links">
                <a href="candidate_dashboard.html"
                    style="color: var(--text-muted); text-decoration: none; margin-right: 1.5rem;">Dashboard</a>
                <a href="jobs.html" style="color: var(--text-muted); text-decoration: none; margin-right: 1.5rem;">Find
                    Jobs</a>
                <a href="courses.html" style="color: white; font-weight: bold; text-decoration: none;">Explore
                    Courses</a>
            </div>
        </div>
        <div style="display: flex; align-items: center; gap: 1rem;">
            <button onclick="logout()" class="btn"
                style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.5); width: auto; padding: 0.5rem 1rem;">Logout</button>
        </div>
    </nav>

    <div class="container" style="max-width: 1200px;">
        <div style="margin-bottom: 2rem;">
            <h1 style="margin-bottom: 0.5rem;">Upskill Your Career</h1>
            <p style="color: var(--text-muted);">Discover courses to bridge your skill gaps and advance your journey.
            </p>
        </div>

        <div style="display: grid; grid-template-columns: 280px 1fr; gap: 2rem; align-items: start;">
            <!-- Sidebar Filters -->
            <aside class="card" style="padding: 1.5rem; position: sticky; top: 100px;">
                <h3
                    style="font-size: 1.1rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--glass-border); padding-bottom: 0.75rem;">
                    Filters</h3>

                <div class="form-group">
                    <label
                        style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 0.5rem;">Search
                        Course</label>
                    <input type="text" id="filter-search" placeholder="Keyword..." oninput="loadCourses()"
                        style="width: 100%;">
                </div>

                <div class="form-group">
                    <label
                        style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 0.5rem;">Skills</label>
                    <select id="filter-skill" multiple placeholder="Select skills..." onchange="loadCourses()">
                        <!-- Dynamic Skills -->
                    </select>
                </div>

                <div class="form-group">
                    <label
                        style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 0.5rem;">Trainer</label>
                    <select id="filter-trainer" onchange="loadCourses()" style="width: 100%;">
                        <option value="">All Trainers</option>
                        <!-- Dynamic Trainers -->
                    </select>
                </div>

                <div class="form-group">
                    <label
                        style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 0.5rem;">Max
                        Fee (BDT)</label>
                    <input type="number" id="filter-fee" placeholder="Limit" oninput="loadCourses()"
                        style="width: 100%;">
                </div>

                <div class="form-group">
                    <label
                        style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 0.5rem;">Mode</label>
                    <select id="filter-mode" onchange="loadCourses()" style="width: 100%;">
                        <option value="All">All Modes</option>
                        <option value="Online">Online</option>
                        <option value="Offline">Offline</option>
                    </select>
                </div>

                <button onclick="resetFilters()"
                    style="width: 100%; background: none; border: 1px solid var(--glass-border); color: var(--text-muted); padding: 0.6rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem; margin-top: 1rem; transition: all 0.2s;">
                    Reset All Filters
                </button>
            </aside>

            <!-- Main Results Area -->
            <main>
                <div id="courses-feed"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 1.5rem;">
                    <p style="text-align: center; color: var(--text-muted); grid-column: 1/-1;">Loading courses...</p>
                </div>
            </main>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script>
        const API_CANDIDATE = 'http://localhost:5000/api/candidate';
        let filterTimeout;
        let skillSelectInstance;

        async function loadCourses() {
            clearTimeout(filterTimeout);

            // Simple debounce for smoother filtering
            filterTimeout = setTimeout(async () => {
                // Get multiple selected skills from TomSelect
                let selectedSkills = [];
                if (skillSelectInstance) {
                    selectedSkills = skillSelectInstance.getValue();
                    if (!Array.isArray(selectedSkills)) {
                        selectedSkills = selectedSkills ? [selectedSkills] : [];
                    }
                }

                const trainer = document.getElementById('filter-trainer').value;
                const maxFee = document.getElementById('filter-fee').value;
                const mode = document.getElementById('filter-mode').value;
                const search = document.getElementById('filter-search').value;

                // Build Query String
                const params = new URLSearchParams();
                if (selectedSkills.length > 0) params.append('skill', selectedSkills.join(','));
                if (trainer) params.append('trainer', trainer);
                if (maxFee) params.append('maxFee', maxFee);
                if (mode && mode !== 'All') params.append('mode', mode);
                if (search) params.append('search', search);

                try {
                    const res = await fetch(`${API_CANDIDATE}/courses?${params.toString()}`, {
                        headers: { 'x-auth-token': localStorage.getItem('token') }
                    });
                    const courses = await res.json();

                    const feed = document.getElementById('courses-feed');
                    feed.innerHTML = '';

                    if (courses.length === 0) {
                        feed.innerHTML = '<div style="text-align: center; padding: 3rem; background: rgba(255,255,255,0.02); border-radius: 12px; border: 1px dashed var(--glass-border);">' +
                            '<p style="color: var(--text-muted); margin: 0;">No courses found matching your criteria.</p>' +
                            '<button onclick="resetFilters()" style="margin-top: 1rem; color: var(--primary-color); background: none; border: none; cursor: pointer; text-decoration: underline;">Clear all filters</button>' +
                            '</div>';
                        return;
                    }

                    courses.forEach(course => {
                        const skillsHtml = course.skills_taught
                            ? course.skills_taught.map(s => `<span class="skill-tag">${s}</span>`).join('')
                            : '';

                        let enrollBtn = '';
                        if (course.is_enrolled) {
                            let statusLabel = 'Enrolled';
                            let btnColor = 'var(--text-muted)';

                            if (course.enrollment_status === 'Applied') {
                                statusLabel = 'Applied';
                                btnColor = '#fbbf24'; // Amber
                                enrollBtn = `<button class="btn" disabled style="background: ${btnColor}; cursor: not-allowed; width: auto; opacity: 0.8; border: none;">${statusLabel}</button>`;
                            } else if (course.enrollment_status === 'Rejected') {
                                statusLabel = 'Re-apply';
                                btnColor = '#6366f1'; // Indigo/Cool Blue
                                enrollBtn = `<button onclick="enroll('${course.course_id}')" class="btn" style="background: ${btnColor}; width: auto; border: none;">${statusLabel}</button>`;
                            } else if (course.enrollment_status === 'Shortlisted' || course.enrollment_status === 'Hired') {
                                statusLabel = 'Enrolled';
                                btnColor = '#10b981'; // Green
                                enrollBtn = `<button class="btn" disabled style="background: ${btnColor}; cursor: not-allowed; width: auto; opacity: 0.8; border: none;">${statusLabel}</button>`;
                            }
                        } else {
                            enrollBtn = `<button onclick="enroll('${course.course_id}')" class="btn" style="width: auto; padding: 0.75rem 2rem;">Enroll Now</button>`;
                        }

                        const div = document.createElement('div');
                        div.className = 'course-card';
                        div.innerHTML = `
                            <div class="header">
                                <div class="trainer-info">
                                    <div class="trainer-logo">${course.trainer_name ? course.trainer_name.charAt(0) : 'T'}</div>
                                    <div>
                                        <h3 style="margin: 0;">${course.title}</h3>
                                        <span style="color: var(--text-muted); font-size: 0.9rem;">${course.trainer_name || 'Individual Trainer'} â€¢ ${course.mode}</span>
                                        <br>
                                        <a href="profile.html?type=trainer&id=${course.trainer_id}" style="font-size: 0.8rem; color: var(--primary-color); text-decoration: underline;">View Trainer Profile</a>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <span style="display: block; font-weight: bold; color: #10b981; font-size: 1.1rem;">${parseFloat(course.fee).toLocaleString()} BDT</span>
                                    <small style="color: var(--text-muted); font-weight: 500;">${course.duration_days} Days</small>
                                </div>
                            </div>
                            
                            <p style="color: #cbd5e0; line-height: 1.6; margin-bottom: 1rem; font-size: 0.95rem;">${course.description || 'No description provided.'}</p>
                            
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 1.25rem;">
                                <div class="skills-list" style="margin: 0;">
                                    ${skillsHtml}
                                </div>
                                ${enrollBtn}
                            </div>
                        `;

                        feed.appendChild(div);
                    });

                } catch (err) {
                    console.error('Filter Error:', err);
                    document.getElementById('courses-feed').innerHTML = '<p style="color: #fca5a5; text-align: center; padding: 2rem;">Connection Error. Could not fetch courses.</p>';
                }
            }, 300);
        }

        async function loadFilterOptions() {
            try {
                const res = await fetch(`${API_CANDIDATE}/course-filters`, {
                    headers: { 'x-auth-token': localStorage.getItem('token') }
                });

                if (!res.ok) throw new Error('Failed to load filters');

                const { skills, trainers } = await res.json();

                const skillSelect = document.getElementById('filter-skill');
                const trainerSelect = document.getElementById('filter-trainer');

                if (skills && skills.length > 0) {
                    skills.forEach(skill => {
                        const opt = document.createElement('option');
                        opt.value = skill;
                        opt.textContent = skill;
                        skillSelect.appendChild(opt);
                    });
                } else {
                    console.warn('No skills found for filter');
                }

                if (trainers && trainers.length > 0) {
                    trainers.forEach(trainer => {
                        const opt = document.createElement('option');
                        opt.value = trainer;
                        opt.textContent = trainer;
                        trainerSelect.appendChild(opt);
                    });
                }

                // Initialize TomSelect for skills (Ensure it initializes even with empty list)
                skillSelectInstance = new TomSelect('#filter-skill', {
                    plugins: ['remove_button'],
                    onItemAdd: function () { this.setTextboxValue(''); this.refreshOptions(); },
                    persist: false,
                    create: false,
                    allowEmptyOption: true,
                    placeholder: skills && skills.length > 0 ? "Search skills..." : "No skills available"
                });

            } catch (err) {
                console.error('Error loading filter options:', err);
                // Initialize anyway to avoid breaking UI
                if (!skillSelectInstance) {
                    skillSelectInstance = new TomSelect('#filter-skill', {
                        placeholder: "Error loading skills"
                    });
                }
            }
        }

        function resetFilters() {
            if (skillSelectInstance) skillSelectInstance.clear();
            document.getElementById('filter-search').value = '';
            document.getElementById('filter-trainer').value = '';
            document.getElementById('filter-fee').value = '';
            document.getElementById('filter-mode').value = 'All';
            loadCourses();
        }

        async function enroll(courseId) {
            try {
                const res = await fetch(`${API_CANDIDATE}/courses/${courseId}/enroll`, {
                    method: 'POST',
                    headers: { 'x-auth-token': localStorage.getItem('token') }
                });

                if (res.ok) {
                    alert('Enrollment request submitted!');
                    loadCourses();
                } else {
                    const data = await res.json();
                    if (res.status === 403 && data.remaining) {
                        // Better formatting for "2 days 23:52:34.946678"
                        let timeStr = data.remaining.split('.')[0]; // remove microseconds
                        timeStr = timeStr.replace(/00:/g, '').trim();
                        alert(`Re-application Cooldown: Please wait ${timeStr} before applying again.`);
                    } else {
                        alert(data.message || 'Enrollment failed');
                    }
                }
            } catch (err) {
                console.error(err);
                alert('Server error');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof checkAuth === 'function') checkAuth();
            loadFilterOptions(); // Load dynamic dropdowns
            loadCourses();
        });
    </script>
</body>

</html>